{%- comment -%}
Global BreadcrumbList JSON-LD (no UI). Covers:
- product → Home › (Collection if present) › Product
- collection/blog/article/page/search
Skips home, cart/checkout/account/404.
{%- endcomment -%}

{%- assign skip_types = 'index,cart,checkout,customers,404' | split: ',' -%}
{%- if skip_types contains request.page_type -%}{% endif -%}
{%- unless skip_types contains request.page_type -%}

{%- assign pos = 1 -%}
{%- capture items -%}
{ "@type":"ListItem","position":{{ pos }},"name":"Home","item":{{ shop.url | json }} }
{%- assign pos = pos | plus: 1 -%}

{%- case request.page_type -%}

  {%- when 'product' -%}
    {%- comment -%} pick best collection {%- endcomment -%}
    {%- assign coll = collection -%}

    {%- if coll == nil -%}
      {%- if product.metafields.custom.primary_collection and product.metafields.custom.primary_collection.value -%}
        {%- assign coll = product.metafields.custom.primary_collection.value -%}
      {%- endif -%}
    {%- endif -%}

    {%- if coll == nil -%}
      {%- assign preferred_handles = 'protein-powder|whey-concentrate|whey-isolate|accessories|samples' | split: '|' -%}
      {%- for c in product.collections -%}
        {%- if preferred_handles contains c.handle -%}
          {%- assign coll = c -%}{%- break -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}

    {%- if coll == nil -%}
      {%- assign generic = 'best-sellers,frontpage,all,new,sale' | split: ',' -%}
      {%- for c in product.collections -%}
        {%- unless generic contains c.handle -%}
          {%- assign coll = c -%}{%- break -%}
        {%- endunless -%}
      {%- endfor -%}
    {%- endif -%}

    {%- if coll -%}
    ,{ "@type":"ListItem","position":{{ pos }},"name":{{ coll.title | strip | json }},"item":{{ (shop.url | append: coll.url) | json }} }
    {%- assign pos = pos | plus: 1 -%}
    {%- endif -%}
    ,{ "@type":"ListItem","position":{{ pos }},"name":{{ product.title | strip | json }},"item":{{ (shop.url | append: product.url) | json }} }

  {%- when 'collection' -%}
    {%- if collection -%}
    ,{ "@type":"ListItem","position":{{ pos }},"name":{{ collection.title | strip | json }},"item":{{ (shop.url | append: collection.url) | json }} }
    {%- endif -%}

  {%- when 'blog' -%}
    {%- if blog -%}
    ,{ "@type":"ListItem","position":{{ pos }},"name":{{ blog.title | strip | json }},"item":{{ (shop.url | append: blog.url) | json }} }
    {%- endif -%}

  {%- when 'article' -%}
    {%- if article -%}
    ,{ "@type":"ListItem","position":{{ pos }},"name":{{ article.blog.title | strip | json }},"item":{{ (shop.url | append: article.blog.url) | json }} }
    {%- assign pos = pos | plus: 1 -%}
    ,{ "@type":"ListItem","position":{{ pos }},"name":{{ article.title | strip | json }},"item":{{ (shop.url | append: article.url) | json }} }
    {%- endif -%}

  {%- when 'page' -%}
    {%- if page -%}
    ,{ "@type":"ListItem","position":{{ pos }},"name":{{ page.title | strip | json }},"item":{{ (shop.url | append: page.url) | json }} }
    {%- endif -%}

  {%- when 'search' -%}
    ,{ "@type":"ListItem","position":{{ pos }},"name":"Search","item":{{ (shop.url | append: '/search?q=' | append: search.terms | url_encode) | json }} }

{%- endcase -%}
{%- endcapture -%}

{%- if items and items != blank -%}
<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"BreadcrumbList",
  "itemListElement":[{{ items | strip }}]
}
</script>
{%- endif -%}

{%- endunless -%}
